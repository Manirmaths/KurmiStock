{% extends "base.html" %}
{% block content %}
<section class="panel">
  <div class="panel-head">
    <h2>Products</h2>
    <div class="actions">
      <button class="btn primary" id="openAdd">➕ Add Product</button>
    </div>
  </div>

<div class="table-wrap">
  <table class="tbl" id="prodTable">
    <thead>
      <tr>
        <th>SKU</th>
        <th>Name</th>
        <th>Units</th>
        <th>Price per unit</th>
      </tr>
    </thead>
    <tbody id="prodBody"><tr><td colspan="4">Loading…</td></tr></tbody>
  </table>
</div>

</section>

<!-- Modal -->
<div id="modal" class="modal" hidden>
  <div class="modal-card">
    <div class="modal-head">
      <h3>Add Product</h3>
      <button class="btn tiny ghost" id="closeAdd">✕</button>
    </div>
    <form id="addForm" class="grid" style="grid-template-columns:1fr 1fr; gap:.8rem">
  <input name="sku" placeholder="SKU *" required>
  <input name="name" placeholder="Name *" required>
  <input name="barcode" placeholder="Barcode (optional)">
  <input name="reorder_point" type="number" min="0" value="0" placeholder="Reorder point">
  <input name="unit_price" type="number" step="0.01" min="0" value="0" placeholder="Unit price">
  <input name="opening_stock" type="number" min="0" value="0" placeholder="Opening stock">
  <div style="grid-column:1 / -1; display:flex; gap:.6rem; justify-content:flex-end">
    <button type="button" class="btn" id="cancelAdd">Cancel</button>
    <button type="submit" class="btn primary">Save</button>
  </div>
</form>

  </div>
</div>

<script>
const modal = document.getElementById('modal');
const openAdd = document.getElementById('openAdd');
const closeAdd = document.getElementById('closeAdd');
const cancelAdd = document.getElementById('cancelAdd');
const addForm = document.getElementById('addForm');
const prodBody = document.getElementById('prodBody');

function toggleModal(show){ modal.hidden = !show; }

openAdd.addEventListener('click', ()=>toggleModal(true));
closeAdd.addEventListener('click', ()=>toggleModal(false));
cancelAdd.addEventListener('click', ()=>toggleModal(false));

async function loadProducts(){
  const [prodRes, stockRes] = await Promise.all([
    fetch('/api/products'),
    fetch('/api/stock')
  ]);
  const products = await prodRes.json();
  const stock = await stockRes.json();
  const stockMap = new Map(stock.map(s => [s.product_id, s.stock || 0]));

  if(!products.length){
    prodBody.innerHTML = '<tr><td colspan="4">No products yet. Click “Add Product”.</td></tr>';
    return;
  }

  prodBody.innerHTML = products.map(p=>{
    const units = stockMap.get(p.id) ?? 0;
    const price = (Number(p.unit_price||0)).toFixed(2);
    return `
      <tr>
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${units}</td>
        <td>${price}</td>
      </tr>
    `;
  }).join('');
}

addForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const form = new FormData(addForm);
  const payload = {
  sku: form.get('sku').trim(),
  name: form.get('name').trim(),
  barcode: form.get('barcode').trim() || null,
  reorder_point: parseInt(form.get('reorder_point')||'0',10),
  unit_price: Number(form.get('unit_price')||'0'),
  opening_stock: parseInt(form.get('opening_stock')||'0',10)
};

  const res = await fetch('/api/products', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(res.ok){
    showToast('Product added', `${payload.name} (${payload.sku})`);
    addForm.reset();
    toggleModal(false);
    loadProducts();
  }else{
    const t = await res.text();
    showToast('Failed to add product', t || 'Server error', 'err');
  }
});

loadProducts();
</script>
{% endblock %}
