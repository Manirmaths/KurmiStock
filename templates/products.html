{% extends "base.html" %}
{% block content %}
<section class="panel">
  <div class="panel-head">
    <h2>Products</h2>
    <div class="actions">
      <button class="btn primary" id="openAdd">➕ Add Product</button>
    </div>
  </div>

  <div class="table-wrap">
    <table class="tbl" id="prodTable">
      <thead>
        <tr>
          <th>SKU</th>
          <th>Name</th>
          <th>Units</th>
          <th>Price</th>
          <th>Expiry</th>
          <th>Added on</th>
        </tr>
      </thead>
      <tbody id="prodBody"><tr><td colspan="6">Loading…</td></tr></tbody>
    </table>
  </div>
</section>

<!-- Modal -->
<div id="modal" class="modal" hidden>
  <div class="modal-card">
    <div class="modal-head">
      <h3>Add Product</h3>
      <button class="btn tiny ghost" id="closeAdd">✕</button>
    </div>

    <form id="addForm" class="grid" style="grid-template-columns:1fr 1fr; gap:.8rem">
      <label>Product Name
        <input name="name" placeholder="e.g., Indomie Chicken 70g" required>
      </label>
      <label>SKU (unique)
        <input name="sku" placeholder="e.g., IND-70G-CH" required>
      </label>

      <label>Quantity (opening stock)
        <input name="opening_stock" type="number" min="0" value="0" placeholder="e.g., 24">
        <small class="hint">Automatically records <em>date added</em> now.</small>
      </label>
      <label>Price per unit
        <input name="unit_price" type="number" min="0" step="0.01" value="0" placeholder="e.g., 120.00">
      </label>

      <label>Expiry date (optional)
        <input name="expiry_date" type="date">
      </label>
      <label>Reorder point (optional)
        <input name="reorder_point" type="number" min="0" value="0" placeholder="e.g., 10">
      </label>

      <div style="grid-column:1 / -1; display:flex; gap:.6rem; justify-content:flex-end; margin-top:.4rem">
        <button type="button" class="btn" id="cancelAdd">Cancel</button>
        <button type="submit" class="btn primary">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
const modal = document.getElementById('modal');
const openAdd = document.getElementById('openAdd');
const closeAdd = document.getElementById('closeAdd');
const cancelAdd = document.getElementById('cancelAdd');
const addForm = document.getElementById('addForm');
const prodBody = document.getElementById('prodBody');

function toggleModal(show){ modal.hidden = !show; }
openAdd.addEventListener('click', ()=>toggleModal(true));
closeAdd.addEventListener('click', ()=>toggleModal(false));
cancelAdd.addEventListener('click', ()=>toggleModal(false));

function fmtMoney(n){ return Number(n||0).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2}); }
function fmtDate(s){ try{ return new Date(s).toLocaleDateString(); }catch(_){ return '-'; } }

async function loadProducts(){
  const [prodRes, stockRes] = await Promise.all([fetch('/api/products'), fetch('/api/stock')]);
  const products = await prodRes.json();
  const stock = await stockRes.json();
  const stockMap = new Map(stock.map(s => [s.product_id, s.stock || 0]));

  if(!products.length){
    prodBody.innerHTML = '<tr><td colspan="6">No products yet. Click “Add Product”.</td></tr>';
    return;
  }

  prodBody.innerHTML = products.map(p=>{
    const units = stockMap.get(p.id) ?? 0;
    return `
      <tr>
        <td>${p.sku}</td>
        <td>${p.name}</td>
        <td>${units}</td>
        <td>${fmtMoney(p.unit_price)}</td>
        <td>${p.expiry_date ? fmtDate(p.expiry_date) : '-'}</td>
        <td>${p.created_at ? fmtDate(p.created_at) : '-'}</td>
      </tr>
    `;
  }).join('');
}

addForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const f = new FormData(addForm);
  const payload = {
    sku: f.get('sku').trim(),
    name: f.get('name').trim(),
    opening_stock: parseInt(f.get('opening_stock')||'0',10),
    unit_price: Number(f.get('unit_price')||'0'),
    expiry_date: f.get('expiry_date') || null,
    reorder_point: parseInt(f.get('reorder_point')||'0',10)
  };

  const res = await fetch('/api/products', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  if(res.ok){
    showToast('Product added', `${payload.name} (${payload.sku})`);
    addForm.reset();
    toggleModal(false);
    loadProducts();
  }else{
    const t = await res.text();
    showToast('Failed to add product', t || 'Server error', 'err');
  }
});

loadProducts();
</script>
{% endblock %}
